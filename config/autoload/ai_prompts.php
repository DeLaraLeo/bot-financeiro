<?php

declare(strict_types=1);

return [
    'classification_prompt' => function(string $messageBody, string $today, string $categories) {
        $todayStart = date('Y-m-d 00:00:00');
        $todayEnd = date('Y-m-d 23:59:59');
        $yesterdayStart = date('Y-m-d 00:00:00', strtotime('-1 day'));
        $yesterdayEnd = date('Y-m-d 23:59:59', strtotime('-1 day'));
        
        $currentWeekStart = date('Y-m-d 00:00:00', strtotime('monday this week'));
        $currentWeekEnd = date('Y-m-d 23:59:59', strtotime('sunday this week'));
        $lastWeekStart = date('Y-m-d 00:00:00', strtotime('monday last week'));
        $lastWeekEnd = date('Y-m-d 23:59:59', strtotime('sunday last week'));
        
        $thisMonthStart = date('Y-m-01 00:00:00');
        $thisMonthEnd = date('Y-m-t 23:59:59');
        $lastMonthStart = date('Y-m-01 00:00:00', strtotime('first day of last month'));
        $lastMonthEnd = date('Y-m-t 23:59:59', strtotime('last day of last month'));
        
        return "Analise esta mensagem: \"{$messageBody}\"\n\nCategorias disponíveis:\n{$categories}\n\nREGRAS OBRIGATÓRIAS:\n1. Retorne APENAS um JSON válido\n2. NÃO inclua explicações, textos ou comentários\n3. NÃO use markdown ou code blocks\n4. Use a data atual {$today} como referência\n\nINTENTS DISPONÍVEIS:\n- expense_registration: usuário está registrando uma despesa COMPLETA com valor e descrição\n- query_expenses: usuário quer consultar suas despesas com período claro\n- greeting: mensagens incompletas, ambíguas, sem sentido, ou qualquer outra coisa\n\nREGRAS DE CLASSIFICAÇÃO:\n\nDESPESA (expense_registration) - APENAS se:\n- Mensagem contém um VALOR monetário explícito (ex: 25,50, R$ 100, 50 reais)\n- Mensagem contém uma DESCRIÇÃO clara do que foi gasto\n- Mensagem é COMPLETA e não ambígua\n\nNÃO classifique como despesa se:\n- Mensagem não tem valor (ex: \"eu gastei\", \"gastei no mercado\")\n- Mensagem não tem descrição (ex: \"gastei 50\", \"paguei 100\")\n- Mensagem é incompleta ou ambígua\n- Mensagem é apenas um número sem contexto (ex: \"1\", \"50\", \"100\")\n\nCONSULTA (query_expenses) - APENAS se:\n- Mensagem pergunta explicitamente sobre gastos/despesas\n- Mensagem menciona um período claro do PASSADO ou PRESENTE (ex: \"este mês\", \"mês passado\", \"últimos 3 meses\", \"hoje\", \"ontem\")\n- Mensagem é uma pergunta completa e clara\n- IMPORTANTE: Aceite variações coloquiais e abreviadas como: \"qnt\" = \"quanto\", \"qto\" = \"quanto\", \"qt\" = \"quanto\", \"hj\" = \"hoje\", \"ont\" = \"ontem\", \"mes\" = \"mês\", \"sem\" = \"semana\"\n\nEXEMPLOS DE CONSULTAS VÁLIDAS (classificar como query_expenses):\n- \"quanto eu gastei hoje?\" → query_expenses\n- \"qnt eu gastei hj?\" → query_expenses\n- \"qto gastei hoje?\" → query_expenses\n- \"quanto gastei ontem?\" → query_expenses\n- \"qnt gastei ont?\" → query_expenses\n- \"quanto gastei este mês?\" → query_expenses\n- \"qnt gastei esse mes?\" → query_expenses\n- \"quanto gastei semana passada?\" → query_expenses\n- \"qnt gastei sem passada?\" → query_expenses\n- \"quanto gastei nos últimos 10 dias?\" → query_expenses\n- \"qnt gastei nos ultimos 10 dias?\" → query_expenses\n- \"quanto gastei com mercado hoje?\" → query_expenses\n- \"qnt gastei com mercado hj?\" → query_expenses\n- \"quanto gastei no mercado este mês?\" → query_expenses\n- \"qnt gastei no mercado esse mes?\" → query_expenses\n\nNÃO classifique como consulta se:\n- Mensagem pede períodos FUTUROS (ex: \"próximos X dias\", \"futuro\", \"daqui a X dias\", \"próxima semana\", \"semana que vem\", \"próximo mês\", \"amanhã\", \"depois de amanhã\")\n- Mensagem é apenas um número (ex: \"1\", \"2\", \"10\")\n- Mensagem não menciona período ou consulta\n- Mensagem é ambígua ou incompleta\n\nIMPORTANTE: Se a mensagem pedir consulta de períodos FUTUROS, classifique como GREETING, pois não é possível consultar despesas futuras.\n\nEXEMPLOS DE PERÍODOS FUTUROS (classificar como GREETING):\n- \"quanto gastei nos próximos 10 dias?\" → GREETING\n- \"quanto gastei semana que vem?\" → GREETING\n- \"quanto gastei amanhã?\" → GREETING\n- \"quanto gastei depois de amanhã?\" → GREETING\n- \"quanto gastei na próxima semana?\" → GREETING\n- \"quanto gastei no próximo mês?\" → GREETING\n- \"quanto gastei daqui a 5 dias?\" → GREETING\n- \"quanto gastei no futuro?\" → GREETING\n- \"quanto gastei no mercado semana que vem?\" → GREETING\n- \"quanto gastei no mercado amanhã?\" → GREETING\n\nGREETING - Use para:\n- Mensagens incompletas ou ambíguas\n- Mensagens sem contexto suficiente\n- Números isolados (ex: \"1\", \"50\", \"100\")\n- Mensagens que não se encaixam em despesa ou consulta\n- Saudações, ajuda, ou qualquer outra coisa\n- Consultas de períodos FUTUROS (qualquer referência a \"próximos\", \"futuro\", \"daqui a\", \"próxima semana\", \"semana que vem\", \"próximo mês\", \"amanhã\", \"depois de amanhã\", etc.)\n\nSe for uma despesa VÁLIDA e COMPLETA, retorne:\n{\"intent\": \"expense_registration\", \"confidence\": 0.9, \"data\": {\"amount_cents\": valor_em_centavos, \"description\": \"descrição\", \"category_hint\": \"categoria\"}}\n\nSe for consulta VÁLIDA e CLARA, retorne:\n{\"intent\": \"query_expenses\", \"confidence\": 0.9, \"data\": {\"period\": \"período em português\", \"start_date\": \"YYYY-MM-DD HH:MM:SS\", \"end_date\": \"YYYY-MM-DD HH:MM:SS\", \"category_filter\": \"categoria_ou_null\"}}\n\nIMPORTANTE: O campo \"period\" DEVE ser sempre em português legível, NUNCA use termos em inglês como \"current_month\". Use: \"este mês\", \"mês passado\", \"últimos 2 meses\", \"hoje\", \"ontem\", \"semana passada\", etc.\n\nREGRAS PARA CÁLCULO DE DATAS - SEGUIR RIGOROSAMENTE:\n\n1. \"últimos X dias\" (ex: \"últimos 10 dias\", \"últimos 17 dias\", \"últimos 30 dias\"):\n   - FÓRMULA: end_date = HOJE (data atual {$today})\n   - FÓRMULA: start_date = HOJE - (X - 1) dias\n   - CRÍTICO: end_date NUNCA pode ser amanhã ou futuro, SEMPRE deve ser HOJE\n   - CRÍTICO: Se hoje é {$today}, end_date DEVE ser {$todayEnd}, NUNCA " . date('Y-m-d 23:59:59', strtotime('+1 day')) . "\n   - Exemplo 1: Se hoje é {$today}, \"últimos 10 dias\" = start_date: " . date('Y-m-d 00:00:00', strtotime('-9 days')) . ", end_date: {$todayEnd}\n   - Exemplo 2: Se hoje é {$today}, \"últimos 17 dias\" = start_date: " . date('Y-m-d 00:00:00', strtotime('-16 days')) . ", end_date: {$todayEnd}\n   - Exemplo 3: Se hoje é {$today}, \"últimos 30 dias\" = start_date: " . date('Y-m-d 00:00:00', strtotime('-29 days')) . ", end_date: {$todayEnd}\n\n2. \"últimas X semanas\":\n   - end_date: HOJE ({$todayEnd})\n   - start_date: HOJE - (X * 7 - 1) dias\n\n3. \"últimos X meses\":\n   - end_date: HOJE ({$todayEnd})\n   - start_date: primeiro dia do mês de (hoje - X meses)\n\n4. \"semana passada\" (CRÍTICO - SEGUIR EXATAMENTE):\n   - \"semana passada\" = semana anterior completa (segunda a domingo da semana anterior)\n   - NÃO é os últimos 7 dias\n   - NÃO inclui dias da semana atual\n   - FÓRMULA EXATA: start_date = segunda-feira da semana anterior, end_date = domingo da semana anterior\n   - Se hoje é {$today}, \"semana passada\" = start_date: {$lastWeekStart}, end_date: {$lastWeekEnd}\n   - CRÍTICO: end_date NUNCA pode ser HOJE ou qualquer dia da semana atual\n   - CRÍTICO: Se hoje é {$today}, end_date DEVE ser {$lastWeekEnd}, NUNCA {$todayEnd}\n\n5. REGRA ABSOLUTA: end_date SEMPRE deve ser a data de HOJE ({$today}), NUNCA amanhã ou qualquer data futura. EXCETO para \"semana passada\" e \"mês passado\", onde end_date é o último dia daquela semana/mês.\n\nSe a mensagem for período FUTURO, retorne:\n{\"intent\": \"greeting\", \"confidence\": 0.9, \"data\": {\"is_future_period\": true}}\n\nSe a mensagem for incompleta, ambígua, sem sentido, ou não se encaixar nos critérios acima, retorne:\n{\"intent\": \"greeting\", \"confidence\": 0.9, \"data\": {}}\n\nExemplos de datas baseados em {$today}:\n- hoje: {$todayStart} a {$todayEnd} (period: \"hoje\")\n- ontem: {$yesterdayStart} a {$yesterdayEnd} (period: \"ontem\")\n- esta semana: {$currentWeekStart} a {$currentWeekEnd} (period: \"esta semana\")\n- semana passada: {$lastWeekStart} a {$lastWeekEnd} (period: \"semana passada\")\n- este mês: {$thisMonthStart} a {$thisMonthEnd} (period: \"este mês\")\n- mês passado: {$lastMonthStart} a {$lastMonthEnd} (period: \"mês passado\")\n- últimos 10 dias: " . date('Y-m-d 00:00:00', strtotime('-9 days')) . " a {$todayEnd} (period: \"últimos 10 dias\")\n- últimos 17 dias: " . date('Y-m-d 00:00:00', strtotime('-16 days')) . " a {$todayEnd} (period: \"últimos 17 dias\")\n- últimos 30 dias: " . date('Y-m-d 00:00:00', strtotime('-29 days')) . " a {$todayEnd} (period: \"últimos 30 dias\")\n\nLEMBRE-SE: Para QUALQUER quantidade de dias (10, 17, 30, 50, 100, etc.), end_date SEMPRE é HOJE ({$todayEnd}), NUNCA amanhã!\n\nRetorne APENAS o JSON:";
    },
    
    'name_extraction_prompt' => function(string $messageBody) {
        return "Analise se esta mensagem contém um nome de pessoa válido:\n\n\"{$messageBody}\"\n\nRetorne apenas JSON: {\"isName\": true/false, \"name\": \"nome extraído\"}";
    }
];
